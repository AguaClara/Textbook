%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
 \ifdefined\DeclareUnicodeCharacterAsOptional
  \DeclareUnicodeCharacter{"00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{"2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{"2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{"2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{"251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{"2572}{\textbackslash}
 \else
  \DeclareUnicodeCharacter{00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{2572}{\textbackslash}
 \fi
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\usepackage{geometry}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}
\addto\captionsenglish{\renewcommand{\contentsname}{Contributor's guide}}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.}}
\addto\captionsenglish{\renewcommand{\tablename}{Table}}
\addto\captionsenglish{\renewcommand{\literalblockname}{Listing}}

\addto\captionsenglish{\renewcommand{\literalblockcontinuedname}{continued from previous page}}
\addto\captionsenglish{\renewcommand{\literalblockcontinuesname}{continues on next page}}

\addto\extrasenglish{\def\pageautorefname{page}}

\setcounter{tocdepth}{0}


        \usepackage{cancel}
    

\title{AguaClara Textbook Documentation}
\date{Jul 12, 2018}
\release{}
\author{AguaClara Cornell}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex

\begin{document}

\maketitle
\sphinxtableofcontents
\phantomsection\label{\detokenize{index::doc}}


This textbook is written and maintained in \sphinxhref{https://github.com/AguaClara/Textbook}{Github} via \sphinxhref{http://www.sphinx-doc.org/en/master/}{Sphinx}. It uses and refers to AguaClara code and functions in \sphinxhref{https://github.com/AguaClara/aide\_design}{aide\_design}. Listed below are the versions of the programs we use:


\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxcaption{These are the software versions used to compile this textbook}\label{\detokenize{index:id2}}\label{\detokenize{index:software-versions}}
\sphinxaftercaption
\begin{tabular}[t]{|\X{10}{20}|\X{10}{20}|}
\hline
\sphinxstyletheadfamily 
Software
&\sphinxstyletheadfamily 
version
\\
\hline
Sphinx
&
1.7.5
\\
\hline
aide\_design
&
0.0.12
\\
\hline
Anaconda
&
4.5.4
\\
\hline
Python
&
3.6.5
\\
\hline
\end{tabular}
\par
\sphinxattableend\end{savenotes}


\chapter{Introduction to RST and Sphinx for Textbook Contributors}
\label{\detokenize{Textbook_Creation_Help/rst_intro:introduction-to-rst-and-sphinx-for-textbook-contributors}}\label{\detokenize{Textbook_Creation_Help/rst_intro:title-rst-intro}}\label{\detokenize{Textbook_Creation_Help/rst_intro::doc}}

\section{What is RST?}
\label{\detokenize{Textbook_Creation_Help/rst_intro:what-is-rst}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-what-is-rst}}
RST stands for ReStructured Text. It is the standard markup language used for documenting python packages. \sphinxhref{http://www.sphinx-doc.org/en/master/}{Sphinx} is the Python package that generates an html website from RST files, and it is what we are using to generate this site. To read more about why we chose RST over markdown or Latex, read the following section, {\hyperref[\detokenize{Textbook_Creation_Help/rst_intro:heading-why-rst}]{\sphinxcrossref{\DUrole{std,std-ref}{Why RST?}}}}.


\subsection{Why RST?}
\label{\detokenize{Textbook_Creation_Help/rst_intro:why-rst}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-why-rst}}
In the beginning, we used markdown. As we tried to add different features to markdown (\DUrole{red}{colored words}, image sizes, citations), we were forced to use raw html and various pre-processors. With these various band-aid solutions came added complexity. Adding sections became cumbersome and awkward as it required ill-defined html. Additionally, providing site-wide style updates was prohibitively time-consuming and complex. Essentially, we were trying to pack too much functionality into markdown. In the search for an alternative, restructured text provided several advantages. Out of the box, RST supports globally-defined styles, figure numbering and referencing, Latex function rendering, image display customization and more. Furthermore, restructured text was already the language of choice for the AIDE ecosystem’s documentation.


\section{Setting up RST for Development}
\label{\detokenize{Textbook_Creation_Help/rst_intro:setting-up-rst-for-development}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-setting-up-rst}}
There are two ways to \sphinxstyleemphasis{quickly} view an RST file. The first is using an \sphinxhref{https://ide.atom.io/}{Atom} plugin that renders the view alongside the source code. This is a good initial test to make sure the RST is proper RST and looks \sphinxstyleemphasis{mostly} correct. However, some functionality, such as any extensions provided by \sphinxhref{http://www.sphinx-doc.org/en/master/}{Sphinx} won’t run in the preview. In order to see the final html that will display on the website, you’ll need to use the second method, running sphinx locally to fully generate the html code. Once you are satisfied with your work and want to push it to the textbook, you’ll need to incorporate it to the master branch. To do so, refer to {\hyperref[\detokenize{Textbook_Creation_Help/rst_intro:publishing-online}]{\sphinxcrossref{Publishing online}}}.


\subsection{Installing the Atom Plugins}
\label{\detokenize{Textbook_Creation_Help/rst_intro:installing-the-atom-plugins}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-installing-atom}}
If you are using the Atom IDE to write RST, you can use the \sphinxhref{https://atom.io/packages/rst-preview-pandoc}{rst-preview-pandoc} plugin to auto-generate a live RST preview within atom (much like the markdown-preview-plus preview page.) To get rst-preview working, you’ll need to install \sphinxhref{https://atom.io/packages/language-restructuredtext}{language-restructuredtext} via atom and \sphinxhref{https://pandoc.org/installing.html}{Pandoc} via your command line (\sphinxcode{\sphinxupquote{pip install pandoc}}). If everything worked, you can use \sphinxcode{\sphinxupquote{ctrl + shift + e}} to toggle a display window for the live-updated RST preview.


\subsection{Building RST Locally with Sphinx}
\label{\detokenize{Textbook_Creation_Help/rst_intro:building-rst-locally-with-sphinx}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-building-rst-locally}}
We use \sphinxhref{http://www.sphinx-doc.org/en/master/}{Sphinx} to build RST locally and remotely. Follow these steps to get \sphinxhref{http://www.sphinx-doc.org/en/master/}{Sphinx} and run it locally:
\begin{enumerate}
\item {} 
Install \sphinxhref{http://www.sphinx-doc.org/en/master/}{Sphinx}, disqus, and a sphinx visual theme using pip: \sphinxcode{\sphinxupquote{pip install sphinx -{-}user -U}} and \sphinxcode{\sphinxupquote{pip install git+https://github.com/rmk135/sphinxcontrib-disqus}}.

\item {} 
Generate all the html by navigating in the command line to the source directory /Textbook and creating the build in that directory with the command line \sphinxcode{\sphinxupquote{make html}}.

\item {} 
View the html generated in the /Textbook/\_build directory by copying the full file path of /Textbook/\_build/html/index.html and pasting it into your browser.

\end{enumerate}

\begin{sphinxadmonition}{note}{Note:}
Regarding \sphinxstylestrong{1.} the master branch for the package implementing disqus in sphinx \sphinxhref{https://github.com/Robpol86/sphinxcontrib-disqus/pull/7}{is broken}, which is why we use a non-standard pip/online installation. If you already have the incorrect sphinx-disqus version installed, uninstall it with \sphinxcode{\sphinxupquote{pip uninstall sphinxcontrib-disqus}} before installing the functioning version.
\end{sphinxadmonition}


\subsection{Publishing Online}
\label{\detokenize{Textbook_Creation_Help/rst_intro:publishing-online}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-publishing-online}}
We use \sphinxhref{https://travis-ci.org/}{Travis} to ensure this site will always contain functional builds. To publish online, you need to:
\begin{enumerate}
\item {} 
Always test your build by first :ref:{}` building RST locally \textless{}heading\_building\_rst\_locally\textgreater{}{}`, and then following the {\hyperref[\detokenize{Textbook_Creation_Help/rst_intro:heading-testing-online}]{\sphinxcrossref{\DUrole{std,std-ref}{testing online}}}} instructions. Once you like how your build looks, follow the steps below to introduce it into the master branch.

\item {} 
Submit a \sphinxhref{https://github.com/AguaClara/Textbook/pulls}{pull request to master}. You’ll need to ask for someone else to review your work at this stage- “request reviewers”. Every pull request \sphinxstylestrong{must} be reviewed by at least one other person.

\item {} 
\sphinxhref{https://travis-ci.org/}{Travis} will build the site using \sphinxhref{http://www.sphinx-doc.org/en/master/}{Sphinx}, and if there aren’t any errors, Travis will report success to GitHub on the “checks” part of the pull request.

\item {} 
All your requested reviewers must now approve and comment on  your commit before the merge is allowed.

\item {} 
Once the PR passes Travis and is approved by another author, feel free to “merge to master.”

\item {} \begin{description}
\item[{To release the master branch, (build the html, pdf, and latex, and upload the pdf to Pages) you’ll need to publish a \sphinxhref{https://github.com/AguaClara/Textbook/releases/new}{GitHub release}. Include a \sphinxhref{https://semver.org/}{semver} version number as the tag (under “Tag: Choose or create”), and a brief description of the updates under “Release Title”. Finally, for the description, detail the changes as much as you see fit and when ready, hit “Publish release”. Example:}] \leavevmode\begin{itemize}
\item {} 
Tag name: 0.1.5

\item {} 
Release title: Filtration section maintenance

\item {} 
Description: Added filter code from aide\_design 0.2.6. Also updated all broken external links.

\end{itemize}

\end{description}

\item {} 
Travis will rebuild the site and push the html to Pages, and the PDF and LaTeX to GitHub Releases under the tag name.

\end{enumerate}

\begin{sphinxadmonition}{important}{Important:}
If your changes to the master branch aren’t pushing to gh-pages, then check the status of the \sphinxhref{https://travis-ci.org/AguaClara/Textbook}{Travis build here}.
\end{sphinxadmonition}


\subsection{Testing Online}
\label{\detokenize{Textbook_Creation_Help/rst_intro:testing-online}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-testing-online}}
To test exactly what will be published, we have a test branch. The test branch is built by Travis and contains all the processed html that Travis produces in \_build/html. This branch is populated when ANY COMMIT IS PUSHED. Meaning, the last commit to be pushed, if it passes the Travis tests, will be built and the output will be placed in the test branch. Also, if the PDF=True environment variable is triggered for a Travis build, the PDF will also be generated and placed in the test branch. To do this, use the “Trigger Build” option in Travis and put:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{script}\PYG{p}{:}
    \PYG{o}{\PYGZhy{}} \PYG{n}{PDF}\PYG{o}{=}\PYG{k+kc}{True}
\end{sphinxVerbatim}

\sphinxhref{https://rawgit.com/AguaClara/Textbook/test/html/index.html}{The website output is viewable here}.


\subsection{Sharing Test Output}
\label{\detokenize{Textbook_Creation_Help/rst_intro:sharing-test-output}}
if you want to share what your latest branch developments look like without having whoever is viewing it actually have to build it, you can push a commit, and find the \sphinxhref{https://rawgit.com/}{rawgit URL with this site} by entering the URL of the git file within the test branch that you’d like to share. Furthermore, if you want to point to the commit so that even if someone else pushes, the URL will still point to the code you intend it to, make sure to include the commit SHA within the rawgit URL like so: \sphinxurl{https://rawgit.com/AguaClara/Textbook/e5693e0485702b95e11d4d6bdf76d07c42fdbf99/html/index.html}. That link will never change where it is pointing. To share the PDF output, follow the {\hyperref[\detokenize{Textbook_Creation_Help/rst_intro:heading-testing-online}]{\sphinxcrossref{\DUrole{std,std-ref}{testing online}}}} instructions to build the PDF, and point to the commit with the PDF. Happy testing!


\section{Brief Best Practices}
\label{\detokenize{Textbook_Creation_Help/rst_intro:brief-best-practices}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-brief-best-practices}}
When writing RST, there are often many ways to write the same thing. Almost always, the way with the fewest number of characters is the best way. Ideally, never copy and paste.


\subsection{How do I write RST?}
\label{\detokenize{Textbook_Creation_Help/rst_intro:how-do-i-write-rst}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-how-do-i-write-rst}}
RST is friendly to learn and powerful. There are many useful cheatsheets, like \sphinxhref{https://thomas-cokelaer.info/tutorials/sphinx/rest\_syntax.html\#inserting-code-and-literal-blocks}{this one} and the next page on this site: \DUrole{xref,std,std-ref}{Functionality in RST and AguaClara Convention}, which is specifically for AguaClara and this textbook project. When you start writing RST, look at the cheat sheets all the time. Use \sphinxcode{\sphinxupquote{ctrl-f}} all the time to find whatever you need.

\sphinxstylestrong{Things not covered in most cheat sheets which are of critical importance:}
\begin{itemize}
\item {} 
A document is referred to by its title, as defined between the \sphinxcode{\sphinxupquote{*****}} signs at the top of the page, \sphinxstylestrong{NOT} the filename. So it is critical to have a title.

\item {} 
Anything else you’d like to add for the future…

\end{itemize}


\subsection{Example to Start From}
\label{\detokenize{Textbook_Creation_Help/rst_intro:example-to-start-from}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-example-to-start-from}}
This file is written in RST. You can start there! Just click on “View page source” at the top of the page.

Also, the next page contains the convention, and is where we specify all AguaClara RST best practices: \DUrole{xref,std,std-ref}{Functionality in RST and AguaClara Convention}. I recommend looking at the raw RST and the rendered html side by side.


\section{Converting Markdown to RST}
\label{\detokenize{Textbook_Creation_Help/rst_intro:converting-markdown-to-rst}}\label{\detokenize{Textbook_Creation_Help/rst_intro:heading-converting-md-to-rst}}
Ideally, use pandoc to do the conversion in the command line: \sphinxcode{\sphinxupquote{pandoc -{-}from=markdown -{-}to=rst -{-}output=my\_file.rst my\_file.md}}.
Raw html will not be converted (because it is not actually markdown), and tables are converted poorly.
You’ll need to carefully review any page converted with pandoc.


\chapter{Parameter Convention List}
\label{\detokenize{Textbook_Creation_Help/parameter_convention_list:parameter-convention-list}}\label{\detokenize{Textbook_Creation_Help/parameter_convention_list:title-parameter-convention-list}}\label{\detokenize{Textbook_Creation_Help/parameter_convention_list::doc}}

\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxcaption{Relevant Dimensions}\label{\detokenize{Textbook_Creation_Help/parameter_convention_list:id1}}\label{\detokenize{Textbook_Creation_Help/parameter_convention_list:table-dimension-table}}
\sphinxaftercaption
\begin{tabular}[t]{|\X{30}{90}|\X{30}{90}|\X{30}{90}|}
\hline
\sphinxstyletheadfamily 
Dimension
&\sphinxstyletheadfamily 
Abbreviation
&\sphinxstyletheadfamily 
Base Unit
\\
\hline
Length
&
\([L]\)
&
meter
\\
\hline
Mass
&
\([M]\)
&
kilogram
\\
\hline
Time
&
\([T]\)
&
second
\\
\hline
\end{tabular}
\par
\sphinxattableend\end{savenotes}

If you would like to be able to \sphinxcode{\sphinxupquote{ctrl+f}} some variables, click on ‘View page source’ on the top right of this window. If you want to know what a greek variable is but don’t know what it’s called, you can view the source text on the file where you found the variable. nu, mu, eta, who actually remembers what these all look like? The letter ‘v’ should sue ‘nu’ for copyright infringement. Or is it the other way around?


\begin{savenotes}\sphinxatlongtablestart\begin{longtable}{|\X{10}{70}|\X{15}{70}|\X{45}{70}|}
\caption{Parameter Guide\strut}\label{\detokenize{Textbook_Creation_Help/parameter_convention_list:id2}}\label{\detokenize{Textbook_Creation_Help/parameter_convention_list:table-parameter-table}}\\*[\sphinxlongtablecapskipadjust]
\hline
\sphinxstyletheadfamily 
Parameter
&\sphinxstyletheadfamily 
Description
&\sphinxstyletheadfamily 
Units
\\
\hline
\endfirsthead

\multicolumn{3}{c}%
{\makebox[0pt]{\sphinxtablecontinued{\tablename\ \thetable{} -- continued from previous page}}}\\
\hline
\sphinxstyletheadfamily 
Parameter
&\sphinxstyletheadfamily 
Description
&\sphinxstyletheadfamily 
Units
\\
\hline
\endhead

\hline
\multicolumn{3}{r}{\makebox[0pt][r]{\sphinxtablecontinued{Continued on next page}}}\\
\endfoot

\endlastfoot

\(m\)
&
Mass
&
\([M]\)
\\
\hline
\(z\)
&
Elevation
&
\([L]\)
\\
\hline
\(L\)
&
Length
&
\([L]\)
\\
\hline
\(W\)
&
Width
&
\([L]\)
\\
\hline
\(H\)
&
Height
&
\([L]\)
\\
\hline
\(D\)
&
Diameter
&
\([L]\)
\\
\hline
\(r\)
&
Radius
&
\([L]\)
\\
\hline
\(A\)
&
Area
&
\([L]^2\)
\\
\hline
\(\rlap{-} V\)
&
Volume
&
\([L]^3\)
\\
\hline
\(v\)
&
Velocity
&
\(\frac{[L]}{[T]}\)
\\
\hline
\(Q\)
&
Flow rate
&
\(\frac{[L]^3}{[T]}\)
\\
\hline
\(n\)
&
Number, Amount
&
Dimensionless
\\
\hline
\(C\)
&
Concentration
&
\(\frac{[M]}{[L]^3}\)
\\
\hline
\(p\)
&
Pressure
&
\(\frac{[M]}{[L][T]^2}\)
\\
\hline
\(g\)
&
Acceleration due to Gravity
&
\(\frac{[L]}{[T]^2}\)
\\
\hline
\(\rho\)
&
Density
&
\(\frac{[M]}{[L]^3}\)
\\
\hline
\(\mu\)
&
Dynamic viscosity
&
\(\frac{[M]}{[T][L]}\)
\\
\hline
\(\nu\)
&
Kinematic viscosity
&
\(\frac{[L]^2}{[T]}\)
\\
\hline
\(h\)
&
Head, Elevation
&
\([L]\)
\\
\hline
\(h_L\)
&
Headloss
&
\([L]\)
\\
\hline
\(h_{\rm f}\)
&
Major Loss (friction)
&
\([L]\)
\\
\hline
\(\epsilon\)
&
Surface roughness
&
\([L]\)
\\
\hline
\(\rm{f}\)
&
Darcy-Weisbach friction factor
&
Dimensionless
\\
\hline
\({\rm Re}\)
&
Reynolds Number
&
Dimensionless
\\
\hline
\(h_e\)
&
Minor Loss (expansion)
&
\([L]\)
\\
\hline
\(K\)
&
Minor Loss coefficient
&
Dimensionless
\\
\hline
\(\Pi\)
&
Dimensionless Proportionality Ratio
&
Dimensionless
\\
\hline
\(\Pi_{vc}\)
&
Vena Contracta Area Ratio
&
Dimensionless
\\
\hline
\(\Pi_{Error}\)
&
Linearity Error Ratio
&
Dimensionless
\\
\hline
\(M\)
&
Fluid Momentum
&
\(\frac{[M][L]}{[T]^2}\)
\\
\hline
\(F\)
&
Force
&
\(\frac{[M][L]}{[T]^2}\)
\\
\hline
\(t\)
&
Time
&
\([T]\)
\\
\hline
\(\theta\)
&
Residence Time
&
\([T]\)
\\
\hline
\(G\)
&
Velocity Gradient/Fluid Deformation
&
\(\frac{1}{[T]}\)
\\
\hline
\(\varepsilon\)
&
Energy Dissipation Rate
&
\(\frac{[L]^2}{[T]^3}\)
\\
\hline
\(\Pi_{\bar G}^{G_{Max}}\)
&
\(\frac{G_{Max}}{\bar G}\) Ratio in a Reactor
&
Dimensionless
\\
\hline
\(\Pi_{\bar \varepsilon}^{\varepsilon_{Max}}\)
&
\(\frac{\varepsilon_{Max}}{\bar \varepsilon}\) Ratio in a Reactor
&
Dimensionless
\\
\hline
\(\Pi_{HS}\)
&
Height to Baffle Spacing in a Flocculator
&
Dimensionless
\\
\hline
\(H_e\)
&
Height Between Flow Expansions in a Flocculator
&
\([L]\)
\\
\hline
\(S\)
&
Spacing Between Two Objects
&
\([L]\)
\\
\hline
\(B\)
&
Center-to-Center Spacing Between Two Objects
&
\([L]\)
\\
\hline
\(T\)
&
Object Thickness
&
\([L]\)
\\
\hline
\(P\)
&
Power
&
\(\frac{[M][L]^2}{[T]^3}\)
\\
\hline
\(\eta_K\)
&
Kolmogorov Length Scale
&
\([L]\)
\\
\hline
\(\lambda_\nu\)
&
Inner Viscous Length Scale
&
\([L]\)
\\
\hline
\(\Pi_{K\nu}\)
&
Ratio of Inner Viscous Length Scale to Kolmogorov Length Scale
&
Dimensionless
\\
\hline
\(\Lambda\)
&
Distance Between Particles
&
\([L]\)
\\
\hline
\end{longtable}\sphinxatlongtableend\end{savenotes}

This is a place holder for ‘Chapter 1: Introduction’ files


\chapter{Flow Control and Measurement Introduction}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:flow-control-and-measurement-introduction}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:title-flow-control-intro}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro::doc}}

\section{Tank with a Valve}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:tank-with-a-valve}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:heading-tank-with-a-valve}}

\subsection{Flow \protect\(Q\protect\) and Water Level \protect\(h\protect\) as a Function of Time}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:flow-and-water-level-as-a-function-of-time}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:heading-qh-as-a-function-of-t}}
Our first step is to see if we can get constant head out of a simple system. The most simple flow control system is a bucket or tank with a hole in it. This system is too coarse to provide constant head. One step above that is a bucket or tank with a valve. This is where we begin our search for constant head.

Using the setup of in the image below, we derive the following equation for flow \(Q\) through the valve as a function of time \(t\). The derivation is found here: {\hyperref[\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-flow-for-a-tank-with-a-valve}]{\sphinxcrossref{\DUrole{std,std-ref}{ for a Tank with a Valve}}}}. You are advised to read through it if you are at all confused about this equation.
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Intro:Q_tank_with_valve}
\begin{split}  \frac{Q}{Q_0} = 1 - \frac{1}{2} \frac{t}{t_{Design}} \frac{h_{Tank}}{h_0}\end{split}
\end{equation}
\begin{DUlineblock}{0em}
\item[] Such that:
\item[] \(Q\) = \(Q(t)\) = flow of hypochlorite through valve at time \(t\)
\item[] \(Q_0\) = flow of hypochlorite through valve at time \(t = 0\)
\item[] \(t\) = elapsed time
\item[] \(t_{Design}\) = time it \sphinxstyleemphasis{would} take for tank to empty if flow stayed constant at \(Q_0\), which it does not
\item[] \(h_{Tank}\) = elevation of water level with reference to tank bottom at time \(t\) = 0
\item[] \(h_0\) = elevation of water level with reference to the valve at time \(t = 0\)
\end{DUlineblock}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{hypochlorinator_variable_explanation}.png}
\caption{This figure shows the variables that are defined in the equation above.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:id1}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:figure-hypochlorinator-variable-explanation-design}}\end{figure}

This equation has historically give students some trouble, and while its nuances are explained in the derivation, they will be quickly summarized here:
\begin{itemize}
\item {} 
\(t_{Design}\) is \sphinxstylestrong{NOT} the time it takes to drain the tank. It is the time that it \sphinxstyleemphasis{would} take to drain the tank \sphinxstyleemphasis{if} the flow rate at time \(t = 0\), \(Q_0\), were the flow rate forever, which it is not. \(t_{Design}\) was used in the derivation to simplify the equation, which is why this potentially-confusing parameter exists. The actual time it takes to drain the tank lies somewhere between \(t_{Design}\) and \(2 \, t_{Design}\) and depends on the ratio \(\frac{h_{Tank}}{h_0}\).

\item {} 
\(h_{Tank}\) is not the same as \(h_{0}\). \(h_{Tank}\) is the height of water level in the tank with reference to the tank bottom. \(h_{0}\) is the water level in the tank with reference to the valve. Neither change with time, they both refer to the water level at one instance in time, \(t = 0\). Therefore, \(h_{0} \geq h_{Tank}\) is always true. If the tank is elevated far above the valve, then the \(h_{0} > > h_{Tank}\). If the valve is at the same elevation as the bottom of the tank, then \(h_{0} = h_{Tank}\). Please refer to the figure above to clarify \(h_{0}\) and \(h_{Tank}\).

\end{itemize}

We can use the proportionality \(Q \propto \sqrt{h}\), which applies to both minor losses and orifices to form a relationship between water level in the tank \(h\) and time \(t\). This proportionality comes from rearranging the minor loss equation \(h = K \frac{Q^2}{2 g A^2}\) for \(Q\) instead of \(h\). A table of proportionality between \(Q\) and math:\sphinxtitleref{h} can be found in \sphinxcode{\sphinxupquote{heading\_h\_Q\_proportionality}}

Using equation \eqref{equation:Flow_Control_and_Measurement/FCM_Intro:Q_tank_with_valve} and this proportionality relationship, we make the following plots. On the left, the valve is at the same elevation as the bottom of the tank, or \(h_{Tank} = h_0\). Our attempt to get a continuous flow rate out of this system is to make \(\frac{h_{Tank}}{h_0}\) very small by elevating the tank far above the valve. On the right, \(\frac{h_{Tank}}{h_0} = \frac{1}{50}\). While the plot looks great and provides essentially constant head, elevating the tank by 50 times its height is not realistic. The ‘tank with a valve’ is not a solution to the constant head problem.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{tank_valve_play}.png}
\caption{These graphs show how manipulation of the variables in the \(Q(t)\) expression can result in effectively constant head.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:id2}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:figure-tank-valve-play}}\end{figure}


\subsection{Drain System for a Tank}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:drain-system-for-a-tank}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:heading-drain-system-for-a-tank}}
While the ‘tank with a valve’ scenario is not a good constant head solution, we can use our understanding of the system to properly design drain systems for AguaClara reactors like flocculators and sedimentation tanks, since they are just tanks with valves. The derivation for the following equation is here, along with more details on AguaClara’s pipe stub method for draining tanks: {\hyperref[\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-diameter-and-time-tank-drain-equation}]{\sphinxcrossref{\DUrole{std,std-ref}{ and  for Tank Drain Equation}}}}. The derived ‘Tank Drain’ equation is as follows:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Intro:Flow_Control_and_Measurement/FCM_Intro:0}
\begin{split}D_{Pipe} = \sqrt{ \frac{8 L_{Tank} W_{Tank}}{\pi t_{Drain}}} {\left( \frac{H_{Tank} \sum K }{2g} \right)^{\frac{1}{4}}}\end{split}
\end{equation}
The equation can also be rearranged to solve for the time it would take to drain a tank given its dimensions and a certain drain pipe size:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Intro:Flow_Control_and_Measurement/FCM_Intro:1}
\begin{split}t_{Drain} =  \frac{8 L_{Tank} W_{Tank}}{\pi D_{Pipe}^2} {\left( \frac{H_{Tank} \sum K }{2g} \right)^{\frac{1}{2}}}\end{split}
\end{equation}
\begin{DUlineblock}{0em}
\item[] Such that:
\item[] \(D_{Pipe}\) = Diameter of the drain piping
\item[] \(L_{Tank}, W_{Tank}, H_{Tank}\) = Tank dimensions
\item[] \(t_{Drain}\) = Time it takes to drain the tank
\item[] \(\sum K\) = Sum of all the minor loss coefficients in the system
\end{DUlineblock}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{pipe_stub_drainage_variables}.png}
\caption{Variables for draining a tank}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:id3}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Intro:figure-pipe-stub-drainage-variables-in-derivation}}\end{figure}


\chapter{Flow Control and Measurement Design}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:flow-control-and-measurement-design}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:title-flow-control-design}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design::doc}}
This section explores AguaClara’s search for constant head in checmial dosing. The term \sphinxstylestrong{constant head} means that the driving head of a system, \(\Delta z\) or \(\Delta h\), does not change over time, even as water flows through or out of the system. Constant head implies constant flow, since the energy driving the flow does not change.

The challenge of constant head in chemical dosing for water treatment plants is not \sphinxstyleemphasis{just} providing one continuous flow of chemicals; it is also varying that flow of chemicals as the flow rate through the plant changes, so that the concentration of chemicals in the raw water stays the same.


\section{Important Terms and Equations}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:important-terms-and-equations}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:heading-fcm-terms-eqs}}
\sphinxstylestrong{Terms:}
\begin{enumerate}
\item {} 
Dose

\item {} 
Coagulant

\item {} 
Chlorination

\item {} 
Turbidity

\item {} 
Organic Matter

\item {} 
Constant Head Tank

\item {} 
Sutro weir

\end{enumerate}

\sphinxstylestrong{Equations:}
\begin{enumerate}
\item {} 
Hagen-Poiseuille equation

\end{enumerate}


\section{AguaClara Flow Control and Measurement Technologies}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:aguaclara-flow-control-and-measurement-technologies}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:heading-aguaclara-flow-control-and-measurement-technologies}}
Each technology or component for this section will have five subsections:
\begin{itemize}
\item {} 
\sphinxstylestrong{What it is}

\item {} 
\sphinxstylestrong{What it does and why}

\item {} 
\sphinxstylestrong{How it works}

\item {} 
\sphinxstylestrong{Notes}

\end{itemize}

Before diving into the technologies, recall the purpose of the chemicals that we are seeking to constantly \sphinxstylestrong{dose}, and why it is important to keep a constant, specific dose. Also recall that ‘dose’ means ‘concentration of chemical’ \sphinxstyleemphasis{in the water we are trying to treat}, not in the stock tanks of the chemicals. \sphinxhref{https://en.wikipedia.org/wiki/Coagulation\_(water\_treatment)}{Coagulant} like alum, PAC, and some iron-based chemicals are used to turn small particles into bigger particles, allowing them to be captured more easily. Waters with high \sphinxhref{https://en.wikipedia.org/wiki/Turbidity}{turbidity}, indicative of a lot of particles like clay and bacteria, require more coagulant to treat effectively. Additionally, waters with a lot of \sphinxhref{https://en.wikipedia.org/wiki/Organic\_matter}{organic matter} require significantly more coagulant to treat. \sphinxhref{https://en.wikipedia.org/wiki/Water\_chlorination}{Chlorine} is used to disinfect water that has already been fully treated. A proper and consistent chlorine dose is required, as too low of a dose creates a risk of reintroduction of pathogens in the distribution system and too high of a dose increases the risk of carcinogenic \sphinxhref{https://en.wikipedia.org/wiki/Disinfection\_by-product}{disinfection byproduct} formation.

\begin{sphinxadmonition}{important}{Important:}
This section will often refer to the proportionality between flow \(Q\) and head \(\Delta h\) (recall that \(\Delta h = h_L\) after applying the head loss trick) by using the ‘proportional to’ symbol, \(\propto\). It is important to remember that it doesn’t necessarily matter whether \(Q\) or \(h_L\) goes first, \(Q \propto \sqrt{h_L}\) is equivalent to saying that \(h_L \propto Q^2\).
\end{sphinxadmonition}


\subsection{“Almost Linear” Flow Controller}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:almost-linear-flow-controller}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:heading-almost-linear-flow-controller}}

\subsubsection{What it is}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:what-it-is}}
This device consists of a bottle of chemical solution, called the \sphinxstylestrong{Constant Head Tank} (CHT), a float valve to keep a solution in the CHT at a constant water level, a flexible tube starting at the bottom of the CHT, and many precisely placed and equally spaced holes in a pipe, as the image below shows. The holes in the pipe hold the other end of the tube that starts at the CHT.

Chemical solution, either coagulant or chlorine, is stored in a stock tank somewhere above the CHT. A different tube connects the stock tank to the float valve within the CHT.


\subsubsection{What it does and why}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:what-it-does-and-why}}
This flow controller provides a constant flow of chemical solution to the water in the plant. When the end of the flexible tube is placed in a hole, the elevation difference between the water level in the bottle and the hole is set and does not change unless the tube is then placed in another hole. Thus, a constant flow is provided while the end of the tube is not moved.

As has been mentioned previously, the amount of chlorine and coagulant that must be added to the raw water changes depending on the flow rate of the plant; the change is necessary to keep the dose constant. More water flowing through the plant means more chlorine is necessary to maintain the dose of chlorine in the treated water. For coagulant, there are also other factors aside from plant flow rate that impact the required dose, including the turbidity and amount of organic matter in the water. The operator must be able to change the dose of both coagulant and chlorine quickly and easily, and they must be able to know the value of the new dose they set. The “Almost Linear” Flow Controller accomplishes this by having a large number of holes in the flow control pipe next to the CHT. This large number of holes gives the operator many options for adjusting the dose, and let them quickly change the flow of chemicals into the raw water by moving the end of the flexible tube from one hole to another.


\subsubsection{How it works}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:how-it-works}}
The idea behind this flow controller is to have a linear relationship between \(Q\) and \(h_L\) (remember that \(h_L\) is equal to \(\Delta h\) when we apply the head loss trick), which can be written as \(Q \propto h_L\). Here, \(Q\) is the flow of chemicals out of the flexible tube, and \(h_L\) is the elevation difference between the water level in the CHT and the end of the flexible tube.

As you remember from section 1.5, the summary of Fluids Review, \(Q \propto \Delta h\), or \(\Delta h \propto Q\) as it was written in the section summary, is only true for the combination of major losses and laminar flow, which makes applicable the Hagen-Poiseuille equation. Therefore, the flow must always be laminar in the flexible tube that goes between the CHT and the holes, and major losses must far exceed minor losses.

It is easy to design for laminar flow, but the “Almost Linear” Flow Controller was unable to make major losses far exceed minor losses. The bending in the flexible tube caused a lot of minor losses which changed in magnitude depending on exactly how the tube was bent. This made the flow controller “almost linear,” but that wasn’t good enough.


\subsubsection{Notes}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:notes}}\begin{itemize}
\item {} 
This flow controller is \sphinxstylestrong{no longer used by AguaClara.}

\item {} 
The tube connecting the CHT to the outlet of chemicals must really belong and, more importantly, \sphinxstylestrong{straight} to form a linear relationship between driving head and flow. This was not true for the “Almost Linear” Flow Controller. When you read about the Linear Chemical Flow Controller (CDC), you will be learning about the replacement to the “Almost Linear” Flow Controller’s replacement.

\end{itemize}


\subsection{Linear Flow Orifice Meter (LFOM)}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:linear-flow-orifice-meter-lfom}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:heading-lfom}}

\subsubsection{What it is}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id1}}
The LFOM is a weir shape cut into a pipe. It was meant to imitate \sphinxhref{http://www.nptel.ac.in/courses/105106114/pdfs/Unit14/14\_3b.pdf}{the Sutro Weir} while being far easier to build. The LFOM is a pipe with rows of holes, or orifices, drilled into it. There are progressively fewer holes per row as you move up the LFOM, as the shape is meant to resemble half a parabola on each side. The size of all holes is the same, and the amount of holes per row are precisely calculated. Water in the entrance tank flows into and down the LFOM, towards the rapid mix and flocculator.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{sutro_v_lfom}.png}
\caption{On the left is a sutro weir. On the right is AguaClara’s approximation of the sutro weir’s geometery. This elegant innovation is called a linear flow orifice meter, or LFOM for short.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id9}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:figure-sutro-v-lfom}}\end{figure}


\subsubsection{What it does and why}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id2}}
The LFOM does one thing and serves two purposes.

What it does:

\sphinxstylestrong{The LFOM creates a linear relationship between water level in the entrance tank and the flow out of the entrance tank.} \sphinxstyleemphasis{It does not control the flow through the plant}. If the LFOM were replaced with a hole in the bottom of the entrance tank, the same flow rate would go through the plant, the only difference being that the water level in the entrance tank would scale with flow squared \(h \propto Q^2\) instead of \(h \propto Q\). For example, if an LFOM has 10 rows of holes and has been designed for a plant whose maximum flow rate is 10 L/s, then the operator knows that the number of rows submerged in water is equal to the flow rate of the plant in L/s. So if the water were up to the third row of holes, there would be 3 L/s of water flowing through the plant.

Why it is useful:
\begin{enumerate}
\item {} 
Allows the operator to measure the flow through the plant quickly and easily, explained above.

\item {} 
Allows for the Linear Chemical Dose Controller, which will be explained next, to automatically adjust the flow of coagulant/chlorine into the plant as the plant flow rate changes. This means the operator would only need to adjust the flow of coagulant when there is a change in turbidity or organic matter.

\end{enumerate}


\subsubsection{How it works}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id3}}
This is best understood with examples. By shaping a weir differently, different relationships between \(Q\) and \(h\) are formed:
* In the case of a \sphinxhref{https://swmm5.files.wordpress.com/2016/09/image00124.jpg}{rectangular weir}, \(Q \propto h^{\frac{3}{2}}\)
* In the case of a \sphinxhref{https://swmm5.files.wordpress.com/2016/09/image0096.jpg}{v-notch weir}, \(Q \propto h^{\frac{5}{2}}\)
* In the case of a \sphinxhref{http://www.engineeringexcelspreadsheets.com/wp-content/uploads/2012/11/Sutro-Weir-Diagram1.jpg}{Sutro weir} and thus LFOM, \(Q \propto h\).


\subsubsection{Notes}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id4}}\begin{itemize}
\item {} 
The LFOM is not perfect. Before the water level reaches the second row of holes, the LFOM is simulating a rectangular weir, and thus \(h \not\propto Q\). The Sutro weir also experiences this problem.

\item {} 
If the water level exceeds the topmost row of the LFOM’s orifices, the linearity also breaks down. The entire LFOM begins to act like an orifice, the exponent of \(Q\) in \(h \propto Q\) becomes greater than 1. This is because the LFOM approaches orifice behavior, and for orifices, \(h \propto Q^2\).

\end{itemize}


\subsection{Linear Chemical Dose Controller (CDC)}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:linear-chemical-dose-controller-cdc}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:heading-linear-cdc}}
Since the Linear Chemical Dose Controller has become the standard in AguaClara, it is often simply called the Chemical Dose Controller, \sphinxstylestrong{or CDC for short}. It can be confusing to describe with words, so be sure to flip through the slides in the ‘Flow Control and Measurement’ powerpoint, as they contain very, very, helpful diagrams of the CDC.


\subsubsection{What it is}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id5}}
The CDC brings together the LFOM and many improvements to the “Almost Linear” Flow Controller. Let’s break it down, with the image below as a guide.
\begin{enumerate}
\item {} 
Start at the Constant Head Tank (CHT). This is the same set up as the “Almost Linear” Flow Controller. The stock tank feeds into the CHT, and the float valve makes sure that the water level in the constant head tank is always the same.

\end{enumerate}

2. Now the tubes. These fix the linearity problems that were the main problem in the “Almost Linear” Flow Controller.
* The tube connected to the bottom of the CHT is large diameter to minimize any head loss through it.
\begin{itemize}
\item {} 
The three thin, straight tubes are designed to generate a lot of major losses and to minimize any minor losses. This is to make sure that major losses far exceed any minor losses, which will ensure that the Hagen-Poiseuille equation is applicable and that flow will be directly proportional to the head, \(Q \propto \Delta h\). Why are there 3 tubes?
\begin{enumerate}
\item {} 
\sphinxstylestrong{3 short instead of 1 short} Removing 2 of the 3 tubes would mean 3 times the flow through the remaining tube. This means the velocity in the tube would be 3 times as fast. Since minor losses scale with \(v^2\) and major losses only scale with \(v\), this would increase the ratio of \(\rm{\frac{minor \, losses}{major \, losses}}\), which would break the linearity we’re trying to achieve. It would also increase the total head loss through the system, resulting in a lower maximum flow rate than before.

\item {} 
\sphinxstylestrong{1 long instead of 3 short} One tube whose length is equal to the three combined would be inconveniently long, and would suffer from the same problems as above. There would be even more head loss through the tube, since its length would be longer.

\end{enumerate}

\item {} 
The large-diameter tube on the right of the three thin, straight tubes is where the chemicals flow out. The end of the tube is connected to both a slider and a ‘drop tube.’ The drop tube allows for supercritical flow of the chemical leaving the dosing tubes; once the chemical enters the drop tube it falls freely and no longer affects the CDC system.

\end{itemize}
\begin{enumerate}
\setcounter{enumi}{2}
\item {} 
The slider rests on a lever. This lever is the critical part of the CDC, it connects the water level in the entrance tank, which is adjusted by the LFOM, to the difference in head between the CHT and the end of the dosing tube. This allows the flow of chemicals to automatically adjust to a change in the plant flow rate, maintaining a constant dose in the plant water. One end of the lever tracks the water level in the entrance tank by using a float. The counterweight on the other side of the lever is to make sure the float ‘floats,’ since this float is usually made of PVC, which is more dense than water.

\item {} 
The slider itself controls the dose of chemicals. For any given plant flow rate, the slider can be adjusted to increase or decrease the amount of chemical flowing through the plant.

\end{enumerate}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{cdc_labelled}.png}
\caption{This is the setup of the chemical dose controller.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id10}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:figure-cdc-labelled}}\end{figure}


\subsubsection{What it does and why}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id6}}
The CDC makes it easy and accurate to dose chemicals. The flow of chemicals automatically adjusts to changes in the plant flow rate to keep a constant dose, set by the operator. When a turbidity event occurs, the operator can change the dose of coagulant by moving the coagulant slider \sphinxstyleemphasis{lower} on the lever to increase the dose. The slider has labelled marks so the operator can record the dose accurately.


\subsubsection{How it works}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id7}}
A lot of design has gone into the CDC. The design equations and their derivations that the following steps are based on can be found here: {\hyperref[\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-design-equations-for-the-cdc}]{\sphinxcrossref{\DUrole{std,std-ref}{Design Equations for the Linear Chemical Dose Controller (CDC)}}}}, and you are very, very strongly encouraged to read them.

The CDC can be designed manually using the equations from the derivation linked above or via aide\_design, using the equations found in \sphinxhref{https://github.com/AguaClara/aide\_design/blob/master/aide\_design/cdc\_functions.py}{cdc\_functions.py}. Either way, the design algorithm is roughly the same:
\begin{enumerate}
\item {} 
Calculate the maximum flow rate, \(Q_{Max, \, Tube}\), through each available dosing tube diameter \(D\) that keeps error due to minor losses below 10\% of total head loss. Recall that tubing diameter is an array, as there are many diameters available at hardware stores and suppliers. This means that for each step, there will be as many solutions as there are reasonable diameters available.

\end{enumerate}
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Design:Flow_Control_and_Measurement/FCM_Design:0}
\begin{split}Q_{Max, \, Tube} = \frac{\pi D^2}{4} \sqrt{\frac{2 h_L g \Pi_{Error}}{\sum{K} }}\end{split}
\end{equation}\begin{enumerate}
\setcounter{enumi}{1}
\item {} 
Calculate how much flow of chemical needs to pass through the CDC at maximum plant flow and maximum chemical dose. This depends on the concentration of chemicals in the stock tank.

\end{enumerate}
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Design:Flow_Control_and_Measurement/FCM_Design:1}
\begin{split}Q_{Max, \, CDC} = \frac{Q_{Plant} \cdot C_{Dose, \, Max}}{C_{StockTank}}\end{split}
\end{equation}\begin{enumerate}
\setcounter{enumi}{2}
\item {} 
Calculate the number of dosing tubes required if the tubes flow at  maximum capacity (round up)

\end{enumerate}
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Design:Flow_Control_and_Measurement/FCM_Design:2}
\begin{split}n_{Tubes} = {\rm ceil} \left( \frac{Q_{Max, \, CDC}}{Q_{Max, \, Tube}} \right)\end{split}
\end{equation}\begin{enumerate}
\setcounter{enumi}{3}
\item {} 
Calculate the length of dosing tube(s) that correspond to each available tube diameter.

\end{enumerate}
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Design:Flow_Control_and_Measurement/FCM_Design:3}
\begin{split}L_{Min} = \left( \frac{g h_L \pi D^4}{128 \nu Q_{Max}} - \frac{Q_{Max}}{16 \pi \nu} \sum{K} \right)\end{split}
\end{equation}\begin{enumerate}
\setcounter{enumi}{4}
\item {} 
Select a tube length from your array of solutions. Pick the longest dosing tube that you can, keeping in mind that the tube(s) must be able to fit in the plant and can’t be longer than the length of the plant wall it will be placed along.

\item {} 
Finally, select the dosing tube diameter and flow rate corresponding to the selected tube length.

\end{enumerate}


\subsubsection{Notes}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:id8}}
Nothing in life is perfect, and the CDC is no exception. It has a few causes of inaccuracy which go beyond non-zero minor losses:
* Float valves are not perfect. There will still be minor fluctuations of the fluid level in the CHT which will result in imperfect dosing.
* Surface tension may resist the flow of chemicals from the dosing tube into the drop tube during low flows. Since the CDC design does not consider surface tension, this is a potential source of error.
* The lever and everything attached to it are not weightless. Changing the dose of coagulant or chlorine means moving the slider along the lever. Since the slider and tubes attached to it (drop tube, dosing tube) have mass, moving the slider means that the torque of the lever is altered. This means that the depth that the float is submerged is changed, which affects \(\Delta h\) of the system. This can be remedied by making the float’s diameter as large as possible, which makes these fluctuations small. This problem can not be avoided entirely.


\section{Section Summary}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:section-summary}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Design:heading-fcm-section-summary}}
1. \sphinxstylestrong{Tank with a valve:}
.. math:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZbs{}\PYG{n}{frac}\PYG{p}{\PYGZob{}}\PYG{n}{Q}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZob{}}\PYG{n}{Q\PYGZus{}0}\PYG{p}{\PYGZcb{}} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYGZbs{}\PYG{n}{frac}\PYG{p}{\PYGZob{}}\PYG{l+m+mi}{1}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZob{}}\PYG{l+m+mi}{2}\PYG{p}{\PYGZcb{}} \PYGZbs{}\PYG{n}{frac}\PYG{p}{\PYGZob{}}\PYG{n}{t}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZob{}}\PYG{n}{t\PYGZus{}}\PYG{p}{\PYGZob{}}\PYG{n}{Design}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZcb{}} \PYGZbs{}\PYG{n}{frac}\PYG{p}{\PYGZob{}}\PYG{n}{h\PYGZus{}}\PYG{p}{\PYGZob{}}\PYG{n}{Tank}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZob{}}\PYG{n}{h\PYGZus{}0}\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

This equation describes flow \(Q\) as a function of time \(t\) of a fluid leaving a tank through a valve. Attempting to get this ‘tank with a valve’ system to yield constant head means raising the tank far, far above the valve that controls the flow. This is unreasonable when designing a flow control system for constant dosing, but can be used to design systems to drain a tank. See the section above for a description of the variables in the equation.
\begin{enumerate}
\setcounter{enumi}{1}
\item {} 
\sphinxstylestrong{LFOM:} The LFOM makes the water level in the entrance tank linear with respect to the flow out of the entrance tank. This is useful in measuring the flow and is a critical component in AguaClara’s chemical dosing system. The LFOM \sphinxstyleemphasis{measures} the flow through the plant, it does not \sphinxstyleemphasis{control} the flow through the plant.

\item {} 
\sphinxstylestrong{The Linear Chemical Dose Controller (CDC)} combines the:
* linear relationship between water level and flow in the entrance tank caused by the LFOM,
* linear relationship between elevation difference and flow caused by the Hagen-Poiseuille equation, which is only valid for major losses under laminar flow, and
* a lever to link the two linear relationships

\end{enumerate}

To keep the chemical dose constant by automatically adjusting the addition of coagulant and chlorine as the plant flow rate varies. Two sliders on the lever allows the operator to change the dose of coagulant and chlorine independently of the plant flow rate.


\chapter{Flow Control and Measurement Derivations}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:flow-control-and-measurement-derivations}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:title-flow-control-derivations}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations::doc}}

\section{\protect\(Q(t)\protect\) for a Tank with a Valve}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:for-a-tank-with-a-valve}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-flow-for-a-tank-with-a-valve}}
This document contains the derivation of the flow through a tank-with-a-valve over time, \(Q(t)\). Our reference will be a simple hypochlorinator, shown in the following image. In the image, a hypochlorite solution is slowly dripping and mixing with piped source water, thereby disinfecting it. The valve is almost closed to make sure that the hypochlorite solution drips instead of flows. At the end of this document is an image which shows the variables in the final equation.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{drip_hypochlorinator}.png}
\caption{This is a common setup for chlorinating water before distributing it to a nearby community.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id1}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-drip-hypochlorinator}}\end{figure}

This derivation begins by finding two equations for flow, \(Q\), through the hypochlorinator and setting them equal to each other. First, the rate of change of the volume of hypochlorite solution in the tank is equivalent to the flow out of the hypochlorinator. Since the volume of hypochlorite solution in the tank is equal to the tank’s cross-sectional area times it height, we get the following equation:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:0}
\begin{split}Q =  - \frac{d\rlap{-}V}{dt} = - \frac{{A_{Tank}}dh}{dt}\end{split}
\end{equation}
\begin{DUlineblock}{0em}
\item[] Such that:
\item[] \(\frac{d\rlap{-}V}{dt}\) = rate of change in volume of solution in the tank
\item[] \(\frac{dh}{dt}\) = rate of change in height of water (hypochlorite solution) level with time
\end{DUlineblock}

Our other equation for flow is the head loss equation. Since major losses are negligible for a short pipe-low flow rate system, we only need to consider minor losses. The only real minor loss in this system occurs in the almost-closed valve that is dripping the hypochlorite solution. However, we will also use the head loss trick. Therefore, the total driving head of the system \(h\) is equal to the minor losses:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:1}
\begin{split}h = h_e = \left( \sum K \right) \frac{Q^2}{2gA_{Valve}^2}\end{split}
\end{equation}
Bear in mind that this is the second form of the minor loss equation as described in \DUrole{xref,std,std-ref}{this derivation}. Rearranging the minor loss equation to solve for \(Q\), it looks like this:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:2}
\begin{split}Q = A_{Valve} \sqrt{\frac{2 h_e g}{\sum K}}\end{split}
\end{equation}
Now we can set both equations for \(Q\) equal to each other and move them both to one side:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:3}
\begin{split}A_{Tank} \frac{dh}{dt} + A_{Valve} \sqrt{\frac{2gh}{\sum K}} = 0\end{split}
\end{equation}
From here, calculus and equation substitution dominate the derivation. Separating the variables of the equation immediately above, we get the following integral:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:4}
\begin{split}\frac{ -A_{Tank}}{{A_{Valve}} \sqrt{\frac{2g}{\sum K}} }   \int \limits_{h_0}^h \frac{dh}{\sqrt h} = \int \limits_0^t {dt}\end{split}
\end{equation}
Which, when integrated, yields:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:5}
\begin{split}\frac{ -A_{Tank}}{A_{Valve} \sqrt{ \frac{2g}{\sum K}} } \cdot 2 \left( \sqrt{h} - \sqrt{h_0} \right) = t\end{split}
\end{equation}
And solved for \(\sqrt{h}\) returns:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:6}
\begin{split}\sqrt h  = \sqrt{h_0} - t \frac{A_{Valve}}{2 A_{tank}} \sqrt {\frac{2g}{\sum K}}\end{split}
\end{equation}
At this point, the steps and equation substitutions may begin to seem unintuitive. Do not worry if you do not understand why \sphinxstyleemphasis{exactly} a particular substitution is occurring. Since we determined above that \(h_e = h\), our equation above for \(\sqrt{h}\) is also an equation for \(\sqrt{h_e}\). As such, we will plug the equation above back into the minor loss equation solved for \(Q\) from above, \(Q = A_{Valve} \sqrt{\frac{2 h_e g}{\sum K}}\), to produce:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:7}
\begin{split}Q = A_{Valve} \sqrt{\frac{2g}{\sum K}} \left( \sqrt{h_0}  - t \frac{A_{Valve}}{2 A_{tank}} \sqrt{\frac{2g}{\sum K}} \right)\end{split}
\end{equation}
Now we can focus on getting rid of the variables \(A_{Valve}\), \(\sum K\), and \(A_{tank}\). By using the minor loss equation once more, we can remove both \(A_{Valve}\) and \(\sum K\). Consider the initial state of the system, when the hypochlorinator is set up and starts dropping its first few drops of hypochlorite solution into the water. The initial flow rate, \(Q_0\), and elevation difference between the water level and the valve, \(h_0\), can be input into the minor loss equation, which can then be solved for \(A_{Valve}\):
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:8}
\begin{split}A_{Valve} = \frac{Q_{0}}{ \sqrt{ \frac{2 h_0 g}{\sum K}} }\end{split}
\end{equation}
Plugging this equation for \(A_{Valve}\) into the equation for \(Q\) just above, we get the following two equations, in which the second equation is a simplified version of the first:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:9}
\begin{split}Q = Q_0 \frac{1}{\sqrt{h_0}} \left( \sqrt{h_0} - \frac{Q_0 t}{2 A_{Tank} \sqrt{h_0}} \right)\end{split}
\end{equation}\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:10}
\begin{split}\frac{Q}{Q_0} = 1 - \frac{t Q_0}{2 A_{Tank} h_0}\end{split}
\end{equation}
This next step will eliminate \(A_{Tank}\). However, it requires some clever manipulation that has a tendency to cause some confusion. We will define a new parameter, \(t_{Design}\), which represents the time it would take to empty the tank \sphinxstylestrong{if the initial flow rate through the valve, :math:{}`Q\_0{}`, stays constant in time}. Of course, the flow \(Q\) through the valve does not stay constant in time, which is why this derivation document exists. But imagining this hypothetical \(t_{Design}\) parameter allows us to form the following equation:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:11}
\begin{split}Q_0 t_{Design} = A_{Tank} h_{Tank}\end{split}
\end{equation}
This equation describes draining all the hypochlorite solution from the tank. The volume of the solution, \(A_{Tank} h_{Tank}\), is drained in \(t_{Design}\). Rearranged, the equation becomes:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:12}
\begin{split}\frac{Q_0}{A_{Tank}} = \frac{h_{Tank}}{t_{Design}}\end{split}
\end{equation}
\begin{DUlineblock}{0em}
\item[] Such that:
\item[] \(h_{Tank}\) = elevation of water level in the tank with reference to tank bottom at the initial state, \(t = 0\)
\end{DUlineblock}

Here lies another common source of confusion. \(h_{Tank}\) is not the same as \(h_{0}\). \(h_{Tank}\) is the height of water level in the tank with reference to the tank bottom. \(h_{0}\) is the water level in the tank with reference to the valve. Therefore, \(h_{0} \geq h_{Tank}\) is true if the valve is located at or below the bottom of the tank. If the tank is elevated far above the valve, then the \(h_{0} > > h_{Tank}\). If the valve is at the same elevation as the bottom of the tank, then \(h_{0} = h_{Tank}\). Please refer to the following image to clarify \(h_{0}\) and \(h_{Tank}\). Also note that both \(h_{Tank}\) and \(h_{0}\) are not variables, they are constants which are defined by the initial state of the hypochlorinator, when the solution just begins to flow.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{hypochlorinator_variable_explanation}.png}
\caption{\(Q_0 =\) initial flow rate of hypochlorite solution at time \(t = 0\), \(t_{Design} =\) time it would take to drain the tank if flow was held constant at \(Q_0\)}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id2}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-hypochlorinator-variable-explanation}}\end{figure}

Finally, our fabricated equivalence, \(\frac{Q_0}{A_{Tank}} = \frac{h_{Tank}}{t_{Design}}\) can be plugged into \(\frac{Q}{Q_0} = 1 - \frac{t Q_0}{2 A_{Tank} h_0}\) to create the highly useful equation for flow rate as a function of time for a drip hypochlorinator:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:13}
\begin{split}\color{purple}{
\frac{Q}{Q_0} = 1 - \frac{1}{2} \frac{t}{t_{Design}} \frac{h_{Tank}}{h_0}
}\end{split}
\end{equation}
Which can be slightly rearranged to yield:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:14}
\begin{split}\color{purple}{
Q(t) = Q_0 \left( 1 - \frac{1}{2} \frac{t}{t_{Design}} \frac{h_{Tank}}{h_0} \right)
}\end{split}
\end{equation}
\begin{DUlineblock}{0em}
\item[] Such that:
\item[] \(Q = Q(t)\) = flow of hypochlorite through valve at time \(t\)
\item[] \(t\) = elapsed time
\item[] \(t_{Design}\) = time it would take for tank to empty \sphinxstyleemphasis{if} flow stayed constant at \(Q_0\), which it does not
\item[] \(h_{Tank}\) = elevation of water level with reference to tank bottom
\item[] \(h_0\) = elevation of water level with reference to the valve
\end{DUlineblock}

“How does this ‘tank with a valve’ scenario differ from the ‘hole in a bucket’ scenario?” some might ask. If you are interested, you may go through the derivation on your own using the orifice equation instead of the minor loss equation for the first step. If you do so you’ll find that the equation remains almost the same, the only difference being that the \(\frac{h_{Tank}}{h_0}\) term drops out for an orifice, as \(h_{Tank} = h_0\). The big difference in the systems lies with the flexibility of having a valve. It can be tightened or loosened to change the flow rate, whereas changing the size of an orifice multiple times in a row is not recommended and is usually irreversible.


\section{\protect\(D(t)\protect\) and \protect\(t(D)\protect\) for Tank Drain Equation}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:and-for-tank-drain-equation}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-diameter-and-time-tank-drain-equation}}
This document contains the derivation of \(D_{Pipe}\), which is the pipe diameter necessary to install in a drain system to entirely drain a tank in time \(t_{Drain}\).

First, it is necessary to understand how AguaClara tank drains work and what they look like. Many tanks, including the flocculator and entrance tank, have a hole in their bottoms which are fitted with \sphinxhref{https://www.mrpoolman.com.au/assets/thumbL/16057.jpg}{pipe couplings}. During normal operation, these couplings have pipe stubs in them, and the pipe stubs are tall enough to go above the water level in the tank and not allow water to flow into the drain. When the pipe stub is removed, the water begins to flow out of the drain, as the image below indicates. The drain pipe consists of pipe and one elbow, shown in the image.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{pipe_stub_drainage}.png}
\caption{This is AguaClara’s alternatives to having valves.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id3}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-pipe-stub-drainage}}\end{figure}

While AguaClara sedimentation tanks use valves instead of pipe to begin the process of draining, the actual drain piping system is the same, pipe and an elbow. The equation that will soon be derived applies to both pipe stub and valve drains.

We will start the derivation from the following equation, which is found in an intermediate step from the ‘\(Q(t)\) {\hyperref[\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-flow-for-a-tank-with-a-valve}]{\sphinxcrossref{\DUrole{std,std-ref}{ for a Tank with a Valve}}}}.’ While this system does not have a valve, it has other sources of minor loss and therefore the equation is still valid.
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:15}
\begin{split}\sqrt h  = \sqrt{h_0} - t \frac{A_{Valve}}{2 A_{Tank}} \sqrt {\frac{2g}{K}}\end{split}
\end{equation}
We need to make some adjustments to this equation before proceeding, to make it applicable for this new drain-system scenario. First, we want to assume that the tank has fully drained. Thus, \(t = t_{Drain}\) and \(h = 0\). Next, we recall that the tank drain is not actually a valve, but just pipe and an elbow, so \(A_{Valve} = A_{Pipe}\). Additionally, there can be multiple points of minor loss in the drain system: the entrance from the tank into the drain pipe, the elbow, and potentially the exit of the water out of the drain pipe. When considering a sedimentation tank, the open valve required to begin drainage also has a minor loss associated with it. Therefore, it is necessary to substitute \(\sum K\) for \(K\) With these substitutions, the equation becomes:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:16}
\begin{split}\sqrt{h_0}  = t_{Drain} \frac{A_{Pipe}}{2 A_{Tank}} \sqrt {\frac{2g}{\sum K}}\end{split}
\end{equation}
Now, with the knowledge that \(A_{Pipe} = \frac{\pi D_{Pipe}^2}{4}\) and rearranging to solve for \(D_{Pipe}\), we obtain the following equation:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:17}
\begin{split}D_{Pipe} = \sqrt{ \frac{8 A_{Tank}}{\pi t_{Drain}} \sqrt{ \frac{h_0 \sum K}{2g} } }\end{split}
\end{equation}
To get the equation in terms of easily measureable tank parameters, we substitute \(L_{Tank} W_{Tank}\) for \(A_{Tank}\). To maintain consistency in variable names, we substitute \(H_{Tank}\) for \(h_0\).

\begin{sphinxadmonition}{note}{Note:}
By saying that \(h_0 = H_{Tank}\), we are making the assumption that the pipe drain is at the same elevation as the bottom of the tank. The pipe drain is actually a little lower than the bottom of the tank, but that would make the tank drain faster than \(t_{Drain}\), which is preferred. Therefore, we are designing a slight safety factor when we say that \(h_0 = H_{Tank}\).
\end{sphinxadmonition}

Finally, we arrive at the equation for drain pipe sizing:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:18}
\begin{split}\color{purple}{
D_{Pipe} = \sqrt{ \frac{8 L_{Tank} W_{Tank}}{\pi t_{Drain}}} \left( \frac{H_{Tank} \sum K}{2g} \right)^{\frac{1}{4}}
}\end{split}
\end{equation}
We can also easily rearrange to find the time required to drain a tank given a drain diameter:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:19}
\begin{split}\color{purple}{
t_{Drain} = \frac{8 L_{Tank} W_{Tank}}{\pi D_{Pipe}^2} \sqrt{ \frac{H_{Tank} \sum K}{2g} }
}\end{split}
\end{equation}
Such that the variables are as the appear in the image below.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{pipe_stub_drainage_variables}.png}
\caption{\(L_{Tank}\) is the length of the tank which goes the page. \(K\) is the aggregate minor loss coefficient of the drain system.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id4}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-pipe-stub-drainage-variables}}\end{figure}


\section{Design Equations for the Linear Chemical Dose Controller (CDC)}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:design-equations-for-the-linear-chemical-dose-controller-cdc}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-design-equations-for-the-cdc}}
This document will include the equation derivations required to design a CDC system. The most important restriction in this design process is maintaining linearity between head \(h\) and flow \(Q\), which is the entire purpose of the CDC. Recall that major losses under laminar flow scale with \(Q\) and minor losses scale with \(Q^2\) Since it is impossible to remove minor losses from the system entirely, we will simply try to make minor losses very small compared to major losses. The CDC does this by including ‘dosing tube(s),’ which are long, straight tubes designed to generate a lot of major losses. There can be one tube or multiple, depending on the design conditions.

We will use the ‘head loss trick’ that was introduced in the Fluids Review section. Therefore, the elevation difference between the water level in the constant head tank (CHT) and the end of the tube connected to the slider, \(\Delta h\), is equal to the head loss between the two points, \(h_L\). Thus, \(\Delta h = h_L = h_e + h_f\).

\begin{sphinxadmonition}{note}{Note:}
There are a lot of equations in this section, and they may quickly get confusing. They are color coded in an attempt to make them easier to follow. There are two final design equations: \(\color{purple}{\bar v_{Max}}\) and math:\sphinxtitleref{color\{purple\}\{L\_\{Min\}\}}, and they will be written in \(\color{purple}{\rm{purple \, text \, coloring}}\) to make them noticeable.
\end{sphinxadmonition}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{CDC_derivation}.png}
\caption{Visual representation of CDC.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id5}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-cdc-derivation}}\end{figure}


\subsection{CDC Design Equation Derivation}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:cdc-design-equation-derivation}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:heading-cdc-design-equation-derivations}}
\begin{sphinxadmonition}{important}{Important:}
\sphinxstylestrong{When designing the CDC, there are a few parameters which are picked and set initially, before applying any equations. These parameters are:}
\end{sphinxadmonition}
\begin{enumerate}
\item {} 
\(D\) = tube diameter. only certain tubing diameters are manufactured (like \(\frac{x}{16}\) inch), so an array of available tube diameters is set initially.

\item {} 
\(\sum K\) = sum of minor loss coefficients for the whole system. This is also set initially, it is usually 2.

\item {} 
\(h_{L_{Max}}\) = maximum elevation difference between CHT water level and outlet of solution. This parameter is usually 20 cm.

\end{enumerate}

We begin by defining the head loss through the system \(h_L\), which is equivalent to defining the driving head \(\Delta h\). Major losses will be coded as red.
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:20}
\begin{split}\color{red}{
  h_{\rm{f}} = \frac{128\nu LQ}{g\pi D^4}
  }\end{split}
\end{equation}
\begin{DUlineblock}{0em}
\item[] Such that:
\item[] \(\nu\) = kinematic viscosity \sphinxstyleemphasis{of the solution going through the dosing tube(s)}. This is either coagulant or chlorine
\item[] \(Q\) = flow rate through the dosing tube(s)
\item[] \(L\) = length of the dosing tube(s)
\end{DUlineblock}

\begin{sphinxadmonition}{note}{Note:}
‘Tube(s)’ is used because there may be 1 or more dosing tubes depending on the particular design.
\end{sphinxadmonition}

Minor losses are equal to:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:21}
\begin{split}h_e = \frac{8 Q^2}{g \pi^2 D^4} \sum{K}\end{split}
\end{equation}
Therefore, the total head loss is a function of flow, and is shown in the following equation.
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:22}
\begin{split}h_L(Q) =
{\color{red}{
  \frac{128\nu L Q}{g \pi D^4}}} +
  \frac{8Q^2}{g \pi^2 D^4} \sum K\end{split}
\end{equation}
Blue will be used to reference \sphinxstyleemphasis{actual} head loss from now on. This is the same equation as above.
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:23}
\begin{split}\color{blue}{
  h_L(Q) = \left( \frac{128\nu L}{g \pi D^4} + \frac{8Q}{g \pi ^2 D^4} \sum{K} \right) Q
  }\end{split}
\end{equation}
This equation is not linear with respect to flow. We can make it linear by turning the variable \(Q\) in the \(\frac{8Q}{g \pi ^2 D^4} \sum{K}\) term into a constant. To do this, we pick a maximum flow rate of coagulant/chlorine through the dose controller, \(Q_{Max}\), and put that into the term in place of \(Q\). The term becomes \(\frac{8Q_{Max}}{g \pi ^2 D^4} \sum{K}\), and our linearized model of head loss, coded as green, becomes:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:24}
\begin{split}\color{green}{
  h_{L_{linear}}(Q) = \left( \frac{128\nu L}{g \pi D^4} + \frac{8Q_{Max}}{g \pi ^2 D^4} \sum{K} \right) Q
  }\end{split}
\end{equation}
Here is a plot of the three colored equations above. Our goal is to minimize the minor losses in the system; to bring the red and blue curves as close as possible to the green one.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{CDC_linearity_model}.png}
\caption{MathCAD generated graph for linearity error analysis. TODO: make this in python}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id6}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-cdc-linearity-model}}\end{figure}


\subsubsection{Designing for the error constraint, \protect\(\Pi_{Error}\protect\)}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:designing-for-the-error-constraint}}
\begin{sphinxadmonition}{important}{Important:}
The first step in the design is to make sure that major losses far exceed minor losses. This will result in an equation for the maximum velocity that can go through the dosing tube(s), \(\color{purple}{\bar v_{Max} }\).
\end{sphinxadmonition}

Minor losses will never be 0, so how much error in our linearity are we willing to accept? Let’s define a new parameter, \(\Pi_{Error}\), as the maximum amount of error we are willing to accept. We are ok with 10\% error or less, so \(\Pi_{Error} = 0.1\).
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:25}
\begin{split}\Pi_{Error} = \frac{\color{green}{ h_{L_{linear}} } - \color{blue}{ h_L }}{\color{green}{ h_{L_{linear}} }} = 1 - \frac{\color{blue}{ h_L }}{\color{green}{ h_{L_{linear}} }}\end{split}
\end{equation}\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:26}
\begin{split}1 - \Pi_{Error} = \frac{\color{blue}{ h_L }}{\color{green}{ h_{L_{linear}} }}\end{split}
\end{equation}
Now we plug \(\color{blue}{ h_L(Q) }\) and \(\color{green}{ h_{L_{linear}} }\) back into the equation for \(1 - \Pi_{Error}\) and take the limit as \(Q \rightarrow 0\), as that is when the relative difference between actual head loss and our linear model for head loss is the greatest.
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:27}
\begin{split}1 - \Pi_{Error} =
  \frac{ \color{blue}{
  \left( \frac{128 \nu L}{g \pi D^4} +
  \cancel{\frac{8Q}{g \pi^2 D^4} \sum{K}}
  \right) Q
  }}
  {\color{green}{
  \left( \frac{128 \nu L}{g \pi D^4} + \frac{8 Q_{Max}}{g \pi^2 D^4} \sum{K} \right) Q
  }}
  =     \frac{\left( \frac{128 \nu L}{g \pi D^4} \right)}{\left( \frac{128 \nu L}{g \pi D^4} + \frac{8 Q_{Max}}{g \pi^2 D^4} \sum{K} \right)}\end{split}
\end{equation}
The next steps are algebraic rearrangements to solve for \(L\). This \(L\) describes the \sphinxstyleemphasis{minimum} length of dosing tube necessary to meet our error constraint at \sphinxstyleemphasis{maximum} flow. Thus, we will refer to it as \(L_{Min, \, \Pi_{Error}}\).
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:28}
\begin{split}\left( 1 - \Pi_{Error} \right)  \frac{128 \nu L}{g \pi D^4} + \left( 1 - \Pi_{Error} \right) \frac{8 Q_{Max}}{g \pi ^2 D^4} \sum{K}  =  \frac{128 \nu L}{g \pi D^4}\end{split}
\end{equation}\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:29}
\begin{split}- \Pi_{Error} \frac{128 \nu L}{g \pi D^4} + \left( 1 - \Pi_{Error} \right) \frac{8 Q_{Max}}{g \pi^2 D^4} \sum{K}  = 0\end{split}
\end{equation}\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:30}
\begin{split}L = \left( \frac{1 - \Pi_{Error}}{\Pi_{Error}} \right) \frac{Q_{Max}}{16 \nu \pi} \sum{K}\end{split}
\end{equation}\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:31}
\begin{split}L_{Min, \, \Pi_{Error}} = L = \left( \frac{1 - \Pi_{Error}}{\Pi_{Error}} \right) \frac{Q_{Max}}{16 \nu \pi} \sum{K}\end{split}
\end{equation}
\begin{DUlineblock}{0em}
\item[] Note that this equation is independent of head loss.
\end{DUlineblock}

Unfortunately, both \(L_{Min, \, \Pi_{Error}}\) and \(Q_{Max}\) are unknowns. We can plug this equation for \(L_{Min, \, \Pi_{Error}}\) back into the head loss equation at maximum flow, which is \(h_{L_{Max}} = \left( \frac{128\nu L Q_{Max}}{g \pi D^4} + \frac{8Q_{Max}^2}{g \pi ^2 D^4} \sum{K} \right)\) and rearrange for \(Q_{Max}\) to get:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:32}
\begin{split}Q_{Max} = \frac{\pi D^2}{4} \sqrt{\frac{2 h_{L_{Max}} g \Pi_{Error}}{\sum K }}\end{split}
\end{equation}

\sphinxstrong{See also:}


\sphinxstylestrong{Function in aide\_design} \sphinxcode{\sphinxupquote{cdc.max\_linear\_flow(Diam, HeadlossCDC, Ratio\_Error, KMinor)}} Returns the maximum flow \(Q_{Max}\) that can go through a dosing tube will making sure that linearity between head loss and flow is conserved.



From this equation for \(Q_{Max}\), we can get to our first design equation, \(\color{purple}{\bar v_{Max}}\) by using the continuity equation \(\bar v_{Max} = \frac{Q_{Max}}{\frac{\pi D^2}{4}}\)
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:33}
\begin{split}\color{purple}{
  \bar v_{Max} = \sqrt{ \frac{2 h_L g \Pi_{Error}}{\sum{K} }}
  }\end{split}
\end{equation}

\subsubsection{Designing for the proper amount of head loss, \protect\(h_{L_{Max}}\protect\)}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:designing-for-the-proper-amount-of-head-loss}}
\begin{sphinxadmonition}{important}{Important:}
The second step in the design is to make sure that the maximum head loss corresponds to the maximum flow of chemicals. This will result in an equation for the length of the dosing tube(s), \(\color{purple}{L_{Min} }\).
\end{sphinxadmonition}

We previously derived an equation for the minimum length of the dosing tube(s), \(L_{Min, \, \Pi_{Error}}\), which was the minimum length needed to ensure that our linearity constraint was met. This equation is shown again below, in red:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:34}
\begin{split}\color{red}{
  L_{Min, \, \Pi_{Error}} = \left( \frac{1 - \Pi_{Error}}{\Pi_{Error}} \right) \frac{Q_{Max}}{16 \nu \pi} \sum{K}
  }\end{split}
\end{equation}
This equation does not, however, account for getting to the proper amount of head loss. If we were to use this equation to design the dosing tubes, we might not end up with the proper amount of flow \(Q_{Max}\) at the maximum head loss \(h_{L{Max}}\). So we need to double check to make sure that we get our desired head loss.

First, consider the head loss at maximum flow that was used to get the equation for \(Q_{Max}\):
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:35}
\begin{split}h_{L_{Max}} = \left( \frac{128 \nu L{Q_{Max}}}{g \pi D^4} + \frac{8 Q_{Max}^2}{g \pi^2 D^4} \sum{K} \right)\end{split}
\end{equation}
Now that we know all of the parameters in this equation except for \(L\), we can solve the equation for \(L\). This the \sphinxstyleemphasis{shortest} tube that generates our required head loss, \(h_{L_{Max}}\).
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:36}
\begin{split}\color{green}{
   L_{Min, \, head loss} = L = \left( \frac{g h_{L_{Max}} \pi D^4}{128 \nu Q_{Max}} - \frac{Q_{Max}}{16 \pi \nu} \sum{K} \right)
   }\end{split}
\end{equation}

\sphinxstrong{See also:}


\sphinxstylestrong{Function in aide\_design:} \sphinxcode{\sphinxupquote{cdc.\_length\_cdc\_tube\_array(FlowPlant, ConcDoseMax, ConcStock, DiamTubeAvail, HeadlossCDC, temp, en\_chem, KMinor)}} Returns \(\color{purple}{L_{Min}}\), takes in the flow rate input of \sphinxstyleemphasis{plant design flow rate}.




\sphinxstrong{See also:}


\sphinxstylestrong{Function in aide\_design:} \sphinxcode{\sphinxupquote{cdc.\_len\_tube(Flow, Diam, HeadLoss, conc\_chem, temp, en\_chem, KMinor)}} Returns \(\color{purple}{L_{Min}}\), takes in the flow rate input of \sphinxstyleemphasis{max flow rate through the dosing tube(s)}.



If you decrease the max flow \(Q_{Max}\) and hold \(h_{L_{Max}}\) constant, \(\color{green}{L_{Min, \, head loss}}\) becomes larger. This means that a CDC system for a plant of 40 \(\frac{L}{s}\) must be different than one for a plant of 20 \(\frac{L}{s}\). If we want to maintain the same head loss at maximum flow in both plants, then the dosing tube(s) will need to be a lot longer for the 20 \(\frac{L}{s}\) plant.

To visualize the distinction between \(\color{red}{  L_{Min, \, \Pi_{Error}}}\) and math:\sphinxtitleref{color\{green\}\{ L\_\{Min, , head loss\}\}}, see the following plot. \(\color{green}{ L_{Min, \, head loss}}\) is discontinuous because it takes in the smallest allowable tube diameter as an input. As the chemical flow rate through the dosing tube(s) decreases, the dosing tube diameter does as well. Whenever you see a jump in the green points, that means the tubing diameter has changed.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{CDC_length_model}.png}
\caption{CDC length modeling in MathCAD.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id7}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-cdc-length-model}}\end{figure}

As you can see, the head loss constraint is more limiting than the linearity constraint when designing for tube length. Therefore, the design equation for tube length is the one which accounts for head loss. This is the second and final design equation for designing the CDC:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:37}
\begin{split}\color{purple}{
L_{Min} = L_{Min, \, head loss} = \left( \frac{g h_{L_{Max}} \pi D^4}{128 \nu Q_{Max}} - \frac{Q_{Max}}{16 \pi \nu} \sum{K} \right)
}\end{split}
\end{equation}
The equations for \(\color{purple}{\bar v_{Max}}\) and \(\color{purple}{L_{Min}}\) are the only ones you \sphinxstylestrong{need} to manually design a CDC.


\subsubsection{CDC Dosing Tube(s) Diameter \protect\(D_{Min}\protect\) Plots}
\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:cdc-dosing-tube-s-diameter-plots}}
Below are equations which also govern the CDC and greatly aid in understanding the physics behind it, but are not strictly necessary in design.

By rearranging \(Q_{Max} = \frac{\pi D^2}{4} \sqrt{\frac{2 h_L g \Pi_{Error}}{\sum K }}\), we can solve for \(D\) to get the \sphinxstyleemphasis{minimum} diameter we can use assuming the shortest tube possible that meets the error constraint, \(\color{red}{L_{Min, \, \Pi_{Error}}}\). If we use a diameter smaller than \(D_{Min, \, \Pi_{Error}}\), we will not be able to simultaneously reach \(Q_{Max}\) and meet the error constraint \(\Pi_{Error}\).
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:38}
\begin{split}\color{blue}{
D_{Min, \, \Pi_{Error}} = \left[ \frac{8 Q_{Max}^2 \sum K}{\Pi_{Error} h_l g \pi^2} \right]^{\frac{1}{4}}
}\end{split}
\end{equation}
We can also find the minimum diameter needed to guarantee laminar flow, which is another critical condition in the CDC design. We can do this by combining the equation for Reynolds number at the maximum \(\rm{Re}\) for laminar flow, \({\rm{Re}}_{Max} = 2100\) with the continuity equation at maximum flow:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:39}
\begin{split}{\rm Re}_{Max}  = \frac{\bar v_{Max} D}{\nu}\end{split}
\end{equation}\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:40}
\begin{split}\bar v_{Max} = \frac{4 Q_{Max}}{\pi D^2}\end{split}
\end{equation}
To get:
\begin{equation}\label{equation:Flow_Control_and_Measurement/FCM_Derivations:Flow_Control_and_Measurement/FCM_Derivations:41}
\begin{split}\color{red}{
D_{Min, \, Laminar} = \frac{4 Q_{Max}}{\pi \nu {\rm{Re}}_{Max}}
}\end{split}
\end{equation}
Combined with the discrete amount of tubing sizes (shown in dark green), we can create a graph of the three diameter constraints:

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=600\sphinxpxdimen]{{CDC_diameter_model}.png}
\caption{CDC diameter modeling in MathCAD.}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:id8}}\label{\detokenize{Flow_Control_and_Measurement/FCM_Derivations:figure-cdc-diameter-model}}\end{figure}

\sphinxhref{https://github.com/AguaClara/Textbook/releases/latest}{PDF and LaTeX versions} %
\begin{footnote}[1]\sphinxAtStartFootnote
PDF and LaTeX versions may contain visual oddities because it is generated automatically. The website is the recommended way to read this textbook. \sphinxhref{https://github.com/AguaClara/Textbook}{Please visit our GitHub site} to submit an issue, contribute, or comment.
%
\end{footnote}.
\paragraph{\sphinxstylestrong{Notes}}



\renewcommand{\indexname}{Index}
\printindex
\end{document}